const spamTracker = new Map();

module.exports = async (ctx, next) => {
    if (!ctx.message || !ctx.message.from) return next();
    
    const userId = ctx.message.from.id;
    const now = Date.now();
    
    if (!spamTracker.has(userId)) {
        spamTracker.set(userId, { count: 1, lastMessage: now });
    } else {
        const userData = spamTracker.get(userId);
        const timeDiff = now - userData.lastMessage;

        if (timeDiff < 3000) { // 3-second spam detection
            userData.count++;
        } else {
            userData.count = 1;
        }

        userData.lastMessage = now;

        if (userData.count > 5) { // More than 5 messages in 3 sec = spam
            try {
                await ctx.deleteMessage();
                await ctx.reply(`⚠️ Stop spamming, ${ctx.from.first_name}!`);
            } catch (err) {
                console.error('Error handling spam:', err);
            }
            return;
        }
        
        spamTracker.set(userId, userData);
    }

    return next();
};
